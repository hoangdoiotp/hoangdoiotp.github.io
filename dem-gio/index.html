<!DOCTYPE html><!--
  Released under CC0 1.0 Universal (Public Domain Dedication)
  You can copy, modify, distribute and perform the work, even for commercial purposes, all without asking permission.
  See: https://creativecommons.org/publicdomain/zero/1.0/
--><html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Trang web đồng hồ đếm giờ (countdown) & bấm giờ (stopwatch) – gọn nhẹ, hoạt động offline." />
  <title>Đồng hồ đếm giờ</title>
  <style>
    :root {
      --bg: #f9fafb;
      --card: #ffffffcc;
      --text: #111827;
      --muted: #6b7280;
      --accent: #2563eb;
      --accent-2: #3b82f6;
      --danger: #dc2626;
      --border: #e5e7eb;
      --shadow: 0 8px 20px rgba(0,0,0,.08);
      --radius: 12px;
      --spacing: 12px;
    }
    * { box-sizing: border-box }
    html, body { height: 100% }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(180deg,#f9fafb,#f3f4f6);
      color: var(--text);
      display: grid; place-items: center; padding: 24px;
    }
    .wrap { width: 100%; max-width: 900px }
    header { text-align: center; margin-bottom: 18px }
    h1 { margin: 0 0 8px; font-size: 28px; letter-spacing: .5px }
    .sub { color: var(--muted); font-size: 14px }.card { background: rgba(255,255,255,0.9); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); backdrop-filter: blur(8px); }
.card-inner { padding: 18px }

.tabs { display: grid; grid-template-columns: repeat(2,1fr); gap: 8px; padding: 8px }
.tab { padding: 12px; text-align: center; border-radius: 8px; border: 1px solid var(--border); cursor: pointer; user-select: none; color: var(--muted); background: #ffffff; transition: background .15s ease, color .15s ease; }
.tab.active { border-color: var(--accent); background: var(--accent-2); color: #fff; font-weight: 600; }

.display { font-variant-numeric: tabular-nums; text-align: center; padding: 16px 12px 6px }
.digits { font-size: clamp(42px, 10vw, 92px); font-weight: 800; letter-spacing: 1px; color: #111827; text-shadow: none; }
.label { color: var(--muted); font-size: 12px; margin-top: 6px; font-style: italic }

.grid { display: grid; gap: 12px }
@media (min-width: 720px) { .grid.cols-3 { grid-template-columns: repeat(3, 1fr) } }

.input { width: 100%; padding: 12px 14px; border-radius: 8px; background: #ffffff; border: 1px solid var(--border); color: var(--text); font-size: 16px }
.input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(37,99,235,.15) }

.btn-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-top: 14px; }
button { border: 1px solid var(--border); background: #ffffff; color: var(--text); padding: 12px; border-radius: 8px; font-size: 15px; cursor: pointer; transition: box-shadow .15s ease; }
button:hover { box-shadow: 0 4px 12px rgba(0,0,0,.08); }
.primary { background: linear-gradient(180deg,#3b82f6,#2563eb); color: #fff; border-color: #2563eb }
.ghost { background: transparent; border-color: #d1d5db }
.danger { background: linear-gradient(180deg,#ef4444,#dc2626); color: #fff; border-color: #b91c1c }

.row { display: grid; gap: 12px }
@media (min-width: 720px) { .row { grid-template-columns: 1.2fr 1fr 1fr } }

.kpis { display: grid; grid-template-columns: repeat(3,1fr); gap: 8px; margin-top: 12px }
.kpi { text-align: center; padding: 10px; border: 1px dashed #334155; border-radius: 10px; color: var(--muted) }

.footer { margin-top: 14px; text-align: center; color: var(--muted); font-size: 12px }

/* Modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:10000}
.modal{width:min(520px,92vw);background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:0 16px 48px rgba(0,0,0,.18);overflow:hidden}
.modal-header{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:600;color:#111827}
.modal-body{padding:14px 16px;color:#374151}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;padding:12px 16px;border-top:1px solid var(--border)}
.modal input[type="text"], .modal input[type="number"], .modal input[type="datetime-local"], .modal textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:8px;background:#fff;color:#111827}
.modal .btn{border:1px solid var(--border);background:#fff;padding:10px 14px;border-radius:8px;cursor:pointer}
.modal .btn.primary{background:linear-gradient(180deg,#3b82f6,#2563eb);color:#fff;border-color:#2563eb}
.modal .btn.ghost{background:transparent}
.modal .btn.danger{background:linear-gradient(180deg,#ef4444,#dc2626);color:#fff;border-color:#b91c1c}

  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Đồng hồ đếm giờ</h1>
      <div class="sub">Đếm ngược & Bấm giờ – chạy offline, gọn nhẹ, lưu cài đặt gần nhất.</div>
    </header><div class="card">
  <div class="tabs">
    <div id="tab-countdown" class="tab active" onclick="switchTab('countdown')">Đếm ngược</div>
    <div id="tab-stopwatch" class="tab" onclick="switchTab('stopwatch')">Bấm giờ</div>
  </div>
  <div class="card-inner">
    <!-- Countdown Panel -->
    <section id="panel-countdown">
      <div class="display">
        <div id="countdownDigits" class="digits">00:00:00</div>
        <div class="label">Giờ : Phút : Giây</div>
      </div>

      <div class="row">
        <div class="grid">
          <label class="muted">Nhập thời lượng (H:M:S)</label>
          <div class="grid cols-3">
            <input id="cd-h" class="input" type="number" min="0" value="0" aria-label="Giờ" />
            <input id="cd-m" class="input" type="number" min="0" max="59" value="5" aria-label="Phút" />
            <input id="cd-s" class="input" type="number" min="0" max="59" value="0" aria-label="Giây" />
          </div>
        </div>
        <div class="grid">
          <label class="muted">Hoặc đếm đến mốc thời gian</label>
          <input id="cd-target" class="input" type="datetime-local" />
        </div>
        <div class="grid">
          <label class="muted">Tùy chọn</label>
          <select id="cd-finish" class="input">
            <option value="beep">Kêu beep khi kết thúc</option>
            <option value="loop">Beep lặp cho đến khi dừng</option>
            <option value="silent">Im lặng</option>
          </select>
        </div>
      </div>
      

      <div class="btn-row">
        <button class="primary" onclick="startCountdown()">Bắt đầu</button>
        <button id="cdPauseBtn" class="ghost" onclick="pauseCountdown()" disabled>Tạm dừng</button>
        <button class="ghost" onclick="resumeCountdown()" disabled id="cdResumeBtn">Tiếp tục</button>
        <button class="ghost" onclick="quickSet(2)">+2 phút</button>
        <button class="ghost" onclick="quickSet(5)">+5 phút</button>
        <button class="ghost" onclick="quickSet(10)">+10 phút</button>
        <button class="danger" onclick="resetCountdown()">Đặt lại</button>
        <!-- THÊM MỚI: nút Reset KPI ngay sau Pomodoro -->
        <button class="danger" onclick="resetKPI()">Reset KPI</button>
      </div>

      <div class="kpis">
        <div class="kpi">Đã chạy: <b id="cdRuns">0</b></div>
        <div class="kpi">Tổng thời gian: <b id="cdTotal">00:00:00</b></div>
        <div class="kpi">Lần gần nhất: <b id="cdLast">—</b></div>
      </div>
    </section>

    <!-- Stopwatch Panel -->
    <section id="panel-stopwatch" style="display:none">
      <div class="display">
        <div id="swDigits" class="digits">00:00:00.000</div>
        <div class="label">Giờ : Phút : Giây . Mili</div>
      </div>

      <div class="btn-row">
        <button class="primary" onclick="startSW()">Bắt đầu</button>
        <button class="ghost" onclick="lapSW()">Lap</button>
        <button class="ghost" onclick="pauseSW()" id="swPauseBtn" disabled>Tạm dừng</button>
        <button class="ghost" onclick="resumeSW()" id="swResumeBtn" disabled>Tiếp tục</button>
        <button class="danger" onclick="resetSW()">Đặt lại</button>
      </div>

      <div id="laps" style="margin-top:10px; max-height:180px; overflow:auto; border:1px dashed #334155; border-radius:10px; padding:8px"></div>
    </section>
  </div>
</div>

<div class="footer">© 2025 - Hoàng Đợi</div>

  </div>  <!-- Toast notify -->  <div id="notify" style="position:fixed;bottom:24px;right:24px;min-width:220px;max-width:300px;background:#fff;border:1px solid var(--border);border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.12);padding:12px 16px;color:var(--text);font-size:14px;display:none;z-index:9999"></div>  <!-- Modal system -->  <div id="modal-backdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <div class="modal-header" id="modal-title">Thông báo</div>
      <div class="modal-body" id="modal-content">Nội dung</div>
      <div class="modal-actions" id="modal-actions">
        <button class="btn" id="modal-cancel">Hủy</button>
        <button class="btn primary" id="modal-ok">OK</button>
      </div>
    </div>
  </div>  <script>
    // ===== Helpers =====
    const two = n => String(n).padStart(2,'0');
    const three = n => String(n).padStart(3,'0');

    const store = {
      set(k,v){ localStorage.setItem(k, JSON.stringify(v)); },
      get(k, def){ try { return JSON.parse(localStorage.getItem(k)) ?? def } catch { return def } }
    };

    function fmtHMS(totalMs) {
      totalMs = Math.max(0, totalMs);
      const ms = totalMs % 1000;
      const totalSec = Math.floor(totalMs / 1000);
      const s = totalSec % 60;
      const totalMin = Math.floor(totalSec / 60);
      const m = totalMin % 60;
      const h = Math.floor(totalMin / 60);
      return `${two(h)}:${two(m)}:${two(s)}${totalMs<1000?'.'+three(ms):''}`;
    }

    // ===== Tabs =====
    function switchTab(id){
      document.getElementById('panel-countdown').style.display = id==='countdown'?'block':'none';
      document.getElementById('panel-stopwatch').style.display = id==='stopwatch'?'block':'none';
      document.getElementById('tab-countdown').classList.toggle('active', id==='countdown');
      document.getElementById('tab-stopwatch').classList.toggle('active', id==='stopwatch');
      store.set('timer_tab', id);
    }

    // ===== Countdown (persist + anti-drift) =====
    let cdTimer = null, cdRemaining = 0, cdState = 'idle', cdDeadline = 0;
    let cdAccumulated = store.get('cd_total', 0), cdRuns = store.get('cd_runs', 0), cdLast = store.get('cd_last', null);

    const cdDigits = document.getElementById('countdownDigits');
    const cdPauseBtn = document.getElementById('cdPauseBtn');
    const cdResumeBtn = document.getElementById('cdResumeBtn');
    const elH = document.getElementById('cd-h');
    const elM = document.getElementById('cd-m');
    const elS = document.getElementById('cd-s');
    const elTarget = document.getElementById('cd-target');
    const elFinish = document.getElementById('cd-finish');

    function updateCdDisplay(ms){ cdDigits.textContent = fmtHMS(ms).replace(/\.\d{3}$/,''); }
    function readDurationMs(){
      const h = parseInt(elH.value||0,10);
      const m = parseInt(elM.value||0,10);
      const s = parseInt(elS.value||0,10);
      return ((h*60 + m)*60 + s) * 1000;
    }

    function persistCountdown(clear=false){
      if (clear){
        store.set('cd_state','idle');
        store.set('cd_deadline',0);
        store.set('cd_remaining',0);
        return;
      }
      store.set('cd_state', cdState);
      store.set('cd_deadline', cdDeadline);
      store.set('cd_remaining', cdRemaining);
      store.set('cd_finish', elFinish.value);
    }

    function restoreCountdown(){
      const state = store.get('cd_state','idle');
      const deadline = store.get('cd_deadline',0);
      const remaining = store.get('cd_remaining',0);
      const finish = store.get('cd_finish','beep');
      if (finish) elFinish.value = finish;

      if (state === 'running' && deadline){
        cdState = 'running'; cdDeadline = deadline;
        const left = deadline - Date.now();
        if (left <= 0) { finishCountdown(); return; }
        updateCdDisplay(left);
        clearInterval(cdTimer); cdTimer = setInterval(loopCountdown, 50);
        cdPauseBtn.disabled = false; cdResumeBtn.disabled = true;
        return;
      }
      if (state === 'paused' && remaining){
        cdState = 'paused'; cdRemaining = remaining;
        updateCdDisplay(remaining);
        cdPauseBtn.disabled = true; cdResumeBtn.disabled = false;
        return;
      }
      cdState = 'idle'; updateCdDisplay(readDurationMs());
    }

    function startCountdown(){
      let ms = readDurationMs();
      if (elTarget.value) {
        const t = new Date(elTarget.value).getTime();
        ms = Math.max(0, t - Date.now());
      }
      if (!ms) { infoModal('Vui lòng nhập thời lượng > 0 hoặc chọn mốc thời gian.', 'Thông báo'); return; }
      cdRemaining = ms;
      cdState = 'running';
      cdDeadline = Date.now() + cdRemaining; // mốc kết thúc tuyệt đối
      persistCountdown();
      clearInterval(cdTimer);
      cdTimer = setInterval(loopCountdown, 50);
      cdPauseBtn.disabled = false; cdResumeBtn.disabled = true;
      store.set('cd_preset', {h: elH.value, m: elM.value, s: elS.value, target: elTarget.value, finish: elFinish.value});
      // MỚI: Thông báo sau khi đã thực thi
      showNotify('Đếm ngược bắt đầu','success');
    }

    function loopCountdown(){
      if (cdState !== 'running') return;
      const left = cdDeadline - Date.now();
      updateCdDisplay(left);
      if (left <= 0) finishCountdown();
    }

    function finishCountdown(){
      clearInterval(cdTimer);
      cdState = 'done';
      updateCdDisplay(0);
      cdRuns++; store.set('cd_runs', cdRuns);
      const lastDur = readDurationMs();
      cdAccumulated += lastDur; store.set('cd_total', cdAccumulated);
      cdLast = new Date().toLocaleString(); store.set('cd_last', cdLast);
      updateKpis();
      notifyFinish();
      persistCountdown(true); // clear persisted state
    }

    function pauseCountdown(){
      if (cdState !== 'running') return;
      const left = Math.max(0, cdDeadline - Date.now());
      cdRemaining = left;
      clearInterval(cdTimer);
      cdState = 'paused';
      cdPauseBtn.disabled = true; cdResumeBtn.disabled = false;
      persistCountdown();
      // MỚI: Thông báo sau khi đã thực thi
      showNotify('Đếm ngược tạm dừng','info');
    }

    function resumeCountdown(){
      if (cdState !== 'paused') return;
      cdDeadline = Date.now() + cdRemaining;
      cdState = 'running';
      clearInterval(cdTimer);
      cdTimer = setInterval(loopCountdown, 50);
      cdPauseBtn.disabled = false; cdResumeBtn.disabled = true;
      persistCountdown();
      // MỚI: Thông báo sau khi đã thực thi
      showNotify('Tiếp tục đếm ngược','success');
    }

async function resetCountdown(){
  const ok = await confirmModal(
    'Bạn có chắc muốn đặt lại đồng hồ và xóa các thiết lập hiện tại?',
    'Xác nhận Đặt lại'
  );
  if (!ok) return; // Người dùng bấm Hủy thì thôi, giữ nguyên trạng thái

  // Dừng & về trạng thái idle
  clearInterval(cdTimer); cdTimer = null; cdState = 'idle';

  // Reset toàn bộ input về mặc định 0 hoặc trống
  elH.value = 0;
  elM.value = 0;
  elS.value = 0;
  elTarget.value = '';

  // Cập nhật hiển thị theo giá trị mặc định
  updateCdDisplay(readDurationMs());

  // Vô hiệu nút tạm dừng / tiếp tục
  cdPauseBtn.disabled = true;
  cdResumeBtn.disabled = true;

  // Xoá mốc đếm hiện tại & trạng thái lưu
  cdDeadline = 0;
  cdRemaining = 0;

  // Lưu preset mới (0/0/0 + target trống) để sau reload vẫn giữ đúng
  store.set('cd_preset', {
    h: elH.value,
    m: elM.value,
    s: elS.value,
    target: elTarget.value,
    finish: elFinish.value
  });

  // Xoá trạng thái đếm đang chạy trong localStorage
  persistCountdown(true);

  // Thông báo (đã có sẵn – sau khi thực thi)
  showNotify('Đã đặt lại đồng hồ', 'error');
}

    function quickSet(min){
      elTarget.value = '';
      elH.value = Math.floor(min/60);
      elM.value = min%60;
      elS.value = 0;
      updateCdDisplay(readDurationMs());
      // MỚI: Thông báo sau khi đã cập nhật
      showNotify(`Thiết lập nhanh +${min} phút`,'info');
    }

    // Sound / Notification when finished
    let loopInterval = null;
    function notifyFinish(){
      const mode = elFinish.value;
      if (mode === 'silent') return;
      const playBeep = () => {
        const ctx = new (window.AudioContext||window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine'; o.frequency.value = 880; // A5
        o.connect(g); g.connect(ctx.destination);
        g.gain.setValueAtTime(0.0001, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.4, ctx.currentTime + 0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.4);
        o.start(); o.stop(ctx.currentTime + 0.45);
      };
      playBeep();
      if (mode === 'loop') {
        clearInterval(loopInterval);
        loopInterval = setInterval(playBeep, 1200);
        const stop = () => { clearInterval(loopInterval); loopInterval=null; window.removeEventListener('click', stop); window.removeEventListener('keydown', stop); };
        window.addEventListener('click', stop); window.addEventListener('keydown', stop);
      }
    }

    function updateKpis(){
      document.getElementById('cdRuns').textContent = cdRuns;
      document.getElementById('cdTotal').textContent = fmtHMS(cdAccumulated).replace(/\.\d{3}$/,'');
      document.getElementById('cdLast').textContent = cdLast || '—';
    }

    // ===== Stopwatch (persist) =====
    let swTimer=null, swStart=0, swElapsed=0, swState='idle', lapIdx=1;
    const swDigits = document.getElementById('swDigits');
    const swPauseBtn = document.getElementById('swPauseBtn');
    const swResumeBtn = document.getElementById('swResumeBtn');
    const lapsDiv = document.getElementById('laps');

    function renderSW(ms){
      const ms3 = ms % 1000; const s = Math.floor(ms/1000) % 60; const m = Math.floor(ms/60000) % 60; const h=Math.floor(ms/3600000);
      swDigits.textContent = `${two(h)}:${two(m)}:${two(s)}.${three(ms3)}`;
    }

    function tickSW(){ renderSW(swElapsed + (Date.now()-swStart)); }

    function startSW(){
      if (swState==='running') return;
      swStart = Date.now();
      swState='running';
      clearInterval(swTimer);
      swTimer = setInterval(tickSW, 16);
      swPauseBtn.disabled=false; swResumeBtn.disabled=true;
      persistSW();
    }
    function lapSW(){
      if(swState!=='running') return;
      const t=swElapsed+(Date.now()-swStart);
      const el=document.createElement('div');
      el.textContent=`Lap ${lapIdx++}: ${fmtHMS(t)}`;
      lapsDiv.prepend(el);
    }
    function pauseSW(){
      if(swState!=='running') return;
      swElapsed += Date.now()-swStart;
      clearInterval(swTimer);
      swState='paused';
      swPauseBtn.disabled=true; swResumeBtn.disabled=false;
      persistSW();
    }
    function resumeSW(){
      if(swState!=='paused') return;
      swStart=Date.now();
      swState='running';
      clearInterval(swTimer);
      swTimer=setInterval(tickSW,16);
      swPauseBtn.disabled=false; swResumeBtn.disabled=true;
      persistSW();
    }
async function resetSW(){
  const ok = await confirmModal('Bạn có chắc muốn đặt lại bấm giờ và xóa toàn bộ lap?', 'Xác nhận Đặt lại');
  if (!ok) return;

  clearInterval(swTimer); swTimer=null;
  swStart=0; swElapsed=0; swState='idle';
  renderSW(0);
  lapsDiv.innerHTML='';
  lapIdx=1;
  swPauseBtn.disabled=true; swResumeBtn.disabled=true;

  persistSW(true); // <— THÊM DÒNG NÀY
  showNotify('Đã đặt lại bấm giờ','error');
}

function persistSW(clear=false){
  if (clear){
    store.set('sw_state','idle');
    store.set('sw_start',0);
    store.set('sw_elapsed',0);
    return;
  }
  store.set('sw_state', swState);
  store.set('sw_start', swStart);
  store.set('sw_elapsed', swElapsed);
}
    function restoreSW(){
      const state = store.get('sw_state','idle');
      const start = store.get('sw_start',0);
      const elapsed = store.get('sw_elapsed',0);
      swState = state; swStart = start; swElapsed = elapsed;
      if (state==='running' && start){
        clearInterval(swTimer); swTimer=setInterval(tickSW,16);
        swPauseBtn.disabled=false; swResumeBtn.disabled=true;
        return;
      }
      if (state==='paused'){
        renderSW(elapsed);
        swPauseBtn.disabled=true; swResumeBtn.disabled=false;
        return;
      }
      renderSW(0);
      swPauseBtn.disabled=true; swResumeBtn.disabled=true;
    }

    // ===== Toast helper (bổ sung) =====
    function showNotify(msg,type="info"){
      const box=document.getElementById('notify');
      box.textContent=msg;
      box.style.display='block';
      box.style.background= type==="success"?"#ecfdf5": type==="error"?"#fef2f2":"#fff";
      box.style.borderColor= type==="success"?"#34d399": type==="error"?"#f87171":"var(--border)";
      box.style.color= type==="success"?"#065f46": type==="error"?"#991b1b":"var(--text)";
      setTimeout(()=>{box.style.display='none'},3000);
    }

    // ===== Modal helpers =====
    function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;');}
    function openModal({title="Thông báo", html="", okText="OK", cancelText=null, onOk=null, onCancel=null}){
      const backdrop = document.getElementById('modal-backdrop');
      const t = document.getElementById('modal-title');
      const c = document.getElementById('modal-content');
      const ok = document.getElementById('modal-ok');
      const cancel = document.getElementById('modal-cancel');

      t.textContent = title;
      c.innerHTML = html;
      ok.textContent = okText || 'OK';
      cancel.style.display = cancelText? 'inline-block':'none';
      cancel.textContent = cancelText || '';

      const close = ()=>{ backdrop.style.display='none'; backdrop.setAttribute('aria-hidden','true'); ok.onclick=null; cancel.onclick=null; window.removeEventListener('keydown',onKey); };
      const onKey = (e)=>{ if(e.key==='Escape'){ close(); onCancel && onCancel(); } };

      ok.onclick = ()=>{ close(); onOk && onOk(); };
      cancel.onclick = ()=>{ close(); onCancel && onCancel(); };

      backdrop.style.display='flex'; backdrop.setAttribute('aria-hidden','false');
      window.addEventListener('keydown', onKey);
    }

    function infoModal(message, title='Thông báo'){
      openModal({title, html:`<p>${esc(message)}</p>`, okText:'Đóng'});
    }
    function confirmModal(message, title='Xác nhận'){
      return new Promise((resolve)=>{
        openModal({title, html:`<p>${esc(message)}</p>`, okText:'Đồng ý', cancelText:'Hủy', onOk:()=>resolve(true), onCancel:()=>resolve(false)});
      });
    }
    function promptModal(label, defVal=''){
      return new Promise((resolve)=>{
        const id = 'modal-input-'+Math.random().toString(36).slice(2);
        openModal({
          title: label,
          html:`<input id="${id}" type="text" value="${esc(defVal)}" autofocus>`,
          okText:'OK',
          cancelText:'Hủy',
          onOk:()=>{ const v=document.getElementById(id).value; resolve(v); },
          onCancel:()=>resolve(null)
        });
        setTimeout(()=>{ const el=document.getElementById(id); if(el) el.focus(); }, 10);
      });
    }
    // Override alert to modal (non-blocking)
    window.alert = (msg)=> infoModal(String(msg));

    // ===== Reset KPI =====
    async function resetKPI(){
      const ok = await confirmModal('Reset toàn bộ KPI? (Đã chạy, Tổng thời gian, Lần gần nhất)','Reset KPI');
      if(!ok) return;
      // Xoá dữ liệu KPI
      store.set('cd_runs', 0);
      store.set('cd_total', 0);
      store.set('cd_last', null);
      // Cập nhật biến đang dùng
      cdRuns = 0; cdAccumulated = 0; cdLast = null;
      updateKpis();
      showNotify('Đã reset KPI','success');
    }

    // ===== Init =====
    (function init(){
      const preset = store.get('cd_preset', null);
      if (preset) { elH.value=preset.h; elM.value=preset.m; elS.value=preset.s; elTarget.value=preset.target||''; elFinish.value=preset.finish||'beep'; }
      updateCdDisplay(readDurationMs());
      updateKpis();
      const lastTab = store.get('timer_tab','countdown');
      switchTab(lastTab);

      // Khôi phục trạng thái sau reload
      restoreCountdown();
      restoreSW();
    })();
  </script></body>
</html>